<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FLAI — Demo en el navegador</title>
  <meta name="description" content="Demo ligera que calcula métricas de equidad/igualdad (proxies) en el navegador con PyScript/Pyodide."/>
  <link rel="stylesheet" href="../assets/styles.css" />
  <!-- PyScript (pin a versión estable) -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
  <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="brand">FLAI</div>
    <nav class="nav">
      <a href="../">Inicio</a>
      <a href="./">Demo</a>
      <a href="../sphinx/">Docs</a>
      <a href="https://github.com/rugonzs/FLAI">GitHub</a>
      <a href="https://rubengonzalez.ai" rel="noopener">Quién soy</a>
    </nav>
  </header>

  <section class="section">
    <div class="card">
      <h2>Demo ligera (cliente) ⚗️</h2>
      <p>
        Sube un CSV o usa el ejemplo. Calcularemos <em>proxies didácticos</em> inspirados en FLAI:
        <strong>Igualdad</strong> ≈ diferencia de paridad estadística (tasa positiva por grupo) y
        <strong>Equidad</strong> ≈ diferencia de TPR (oportunidad igualada).
      </p>
      <p class="notice">
        Para resultados científicos y la métrica 2D exacta usa la librería <code class="inline">flai-causal</code> en Python (servidor / local).
      </p>
    </div>
  </section>

  <section class="section card">
    <h3>1) Datos</h3>
    <details>
      <summary>Formato esperado</summary>
      <pre>
Columnas mínimas:
- group  (string/int)  → grupo sensible (p.ej. 0/1, F/M, etc.)
- y_true (0/1)         → etiqueta real
- y_pred (0/1)         → predicción (o usa score y umbral)
Opcional:
- score (0..1)         → probabilidad / score
      </pre>
    </details>
    <div class="nav">
      <input id="file" type="file" accept=".csv" />
      <button id="load-example" class="btn secondary">Cargar ejemplo</button>
    </div>
    <div id="table-preview" class="section"></div>
  </section>

  <section class="section card">
    <h3>2) Umbral (si hay score)</h3>
    <input type="range" id="threshold" min="0" max="1" step="0.01" value="0.5" />
    <span id="thv">0.50</span>
  </section>

  <section class="section card">
    <h3>3) Métricas</h3>
    <div id="results"></div>
  </section>

  <footer>
    © <span id="year"></span> FLAI — Demo educativa con PyScript/Pyodide.
  </footer>
</div>

<script type="py" config='{"packages": ["pandas"]}'>
from pyscript import display
import pandas as pd
import io, js

state = {"df": None}

def parse_csv(text):
    df = pd.read_csv(io.StringIO(text))
    df.columns = [c.strip().lower() for c in df.columns]
    return df

def compute_metrics(df, threshold=0.5):
    df = df.copy()
    cols = df.columns.tolist()
    if "y_pred" not in cols and "score" in cols:
        df["y_pred"] = (df["score"] >= threshold).astype(int)
    assert {"group","y_true","y_pred"}.issubset(df.columns), "Faltan columnas requeridas"
    groups = list(df["group"].astype(str).unique())
    if len(groups) != 2:
        raise ValueError("Esta demo admite 2 grupos para simplificar (en tus datos hay %d)" % len(groups))
    g0, g1 = sorted(groups)
    def rate_pos(g):
        sub = df[df["group"].astype(str)==g]
        return (sub["y_pred"]==1).mean()
    def tpr(g):
        sub = df[(df["group"].astype(str)==g) & (df["y_true"]==1)]
        return (sub["y_pred"]==1).mean() if len(sub) else float("nan")
    def fpr(g):
        sub = df[(df["group"].astype(str)==g) & (df["y_true"]==0)]
        return (sub["y_pred"]==1).mean() if len(sub) else float("nan")
    spd = rate_pos(g1) - rate_pos(g0)
    eod = tpr(g1) - tpr(g0)
    di  = (rate_pos(g0)+1e-12)/(rate_pos(g1)+1e-12)
    out = {
        "grupos":[g0,g1],
        "paridad_positiva":[rate_pos(g0), rate_pos(g1)],
        "tpr":[tpr(g0), tpr(g1)],
        "fpr":[fpr(g0), fpr(g1)],
        "SPD (g1 - g0)": spd,
        "EOD (g1 - g0)": eod,
        "DI (g0/g1)": di
    }
    return out

def format_pct(x):
    return "—" if pd.isna(x) else f"{x*100:.1f}%"

def render(out):
    g0, g1 = out["grupos"]
    html = f'''
    <div class="grid">
      <div>
        <h4>Paridad estadística</h4>
        <p><strong>{g0}</strong>: {format_pct(out["paridad_positiva"][0])}<br>
           <strong>{g1}</strong>: {format_pct(out["paridad_positiva"][1])}</p>
      </div>
      <div>
        <h4>TPR (oportunidad)</h4>
        <p><strong>{g0}</strong>: {format_pct(out["tpr"][0])}<br>
           <strong>{g1}</strong>: {format_pct(out["tpr"][1])}</p>
      </div>
      <div>
        <h4>FPR</h4>
        <p><strong>{g0}</strong>: {format_pct(out["fpr"][0])}<br>
           <strong>{g1}</strong>: {format_pct(out["fpr"][1])}</p>
      </div>
    </div>
    <div class="section">
      <div class="kpis">
        <div class="k"><div class="v">{out["SPD (g1 - g0)"]:+.3f}</div><div class="l">Igualdad ≈ SPD</div></div>
        <div class="k"><div class="v">{out["EOD (g1 - g0)"]:+.3f}</div><div class="l">Equidad ≈ ΔTPR</div></div>
        <div class="k"><div class="v">{out["DI (g0/g1)"]:.3f}</div><div class="l">Disparate Impact</div></div>
      </div>
    </div>
    <p class="notice">
      *Esta demo es pedagógica (cliente). Para la métrica 2D exacta usa <code class="inline">flai-causal</code>.
    </p>
    '''
    display(html, target="results")

def load_example():
    import numpy as np, random
    random.seed(42); np.random.seed(42)
    n=200
    group = np.random.choice(["A","B"], size=n, p=[0.5,0.5])
    y_true = (np.random.rand(n) < (0.5 + 0.1*(group=="B"))).astype(int)
    score  = np.clip(0.3 + 0.5*y_true + 0.15*(group=="B") + np.random.randn(n)*0.2, 0, 1)
    df = pd.DataFrame({"group":group,"y_true":y_true,"score":score})
    state["df"] = df
    display(df.head().to_html(index=False), target="table-preview")
    import js
    th = float(js.document.getElementById("threshold").value)
    out = compute_metrics(df, threshold=th)
    render(out)

def on_file(text):
    df = parse_csv(text); state["df"] = df
    display(df.head().to_html(index=False), target="table-preview")
    import js
    th = float(js.document.getElementById("threshold").value)
    out = compute_metrics(df, threshold=th)
    render(out)

def on_threshold():
    if state["df"] is None: 
        return
    import js
    th = float(js.document.getElementById("threshold").value)
    out = compute_metrics(state["df"], threshold=th)
    render(out)

import js
js.window.py_load_example = load_example
js.window.py_on_file = on_file
js.window.py_on_threshold = on_threshold
</script>

<script>
  const file = document.getElementById('file');
  const loadBtn = document.getElementById('load-example');
  const th = document.getElementById('threshold');
  const thv = document.getElementById('thv');
  document.getElementById('year').textContent = new Date().getFullYear();
  loadBtn.addEventListener('click', () => window.py_load_example());
  file.addEventListener('change', async (e) => {
    const f = e.target.files[0];
    if(!f) return;
    const text = await f.text();
    window.py_on_file(text);
  });
  th.addEventListener('input', () => {
    thv.textContent = Number(th.value).toFixed(2);
    window.py_on_threshold();
  });
</script>
</body>
</html>