<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FLAI — Demo en el navegador</title>
  <meta name="description" content="Demo ligera que calcula métricas de equidad/igualdad (proxies) en el navegador con PyScript/Pyodide."/>
  <link rel="stylesheet" href="../assets/styles.css" />
  <style>
    .table{width:100%; border-collapse:collapse; background:#0f1526; border:1px solid #1a243a; border-radius:12px; overflow:hidden}
    .table th,.table td{padding:10px 12px; border-bottom:1px solid #1a243a; text-align:left}
    .table thead th{background:#0f1729; color:#cdd6ea; position:sticky; top:0}
    .table tbody tr:hover{background:#0e1424}
  </style>
  <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
  <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="brand">FLAI</div>
    <nav class="nav">
      <a href="../">Inicio</a>
      <a href="./">Demo</a>
      <a href="../sphinx/">Docs</a>
      <a href="https://github.com/rugonzs/FLAI">GitHub</a>
      <a href="https://rubengonzalez.ai" rel="noopener">Quién soy</a>
    </nav>
  </header>

  <section class="section">
    <div class="card">
      <h2>Demo ligera (cliente) ⚗️</h2>
      <p>
        Carga un CSV o pulsa uno de los ejemplos. Calcularemos <em>proxies didácticos</em> inspirados en FLAI:
        <strong>Igualdad</strong> ≈ SPD (paridad estadística) y <strong>Equidad</strong> ≈ ΔTPR (oportunidad).
      </p>
      <div class="cta-row">
        <button id="btn-ex1" class="btn">Ejemplo 1 · bajo sesgo</button>
        <button id="btn-ex2" class="btn secondary">Ejemplo 2 · sesgo notable</button>
      </div>
    </div>
  </section>

  <section class="section card">
    <h3>1) Datos</h3>
    <div class="nav" style="margin-bottom:8px;">
      <input id="file" type="file" accept=".csv" />
    </div>
    <div id="table-preview" class="section"></div>
  </section>

  <section class="section card">
    <h3>2) Umbral (si hay score)</h3>
    <input type="range" id="threshold" min="0" max="1" step="0.01" value="0.5" />
    <span id="thv">0.50</span>
  </section>

  <section class="section card">
    <h3>3) Métricas</h3>
    <div id="results"></div>
  </section>

  <footer>
    © <span id="year"></span> FLAI — Demo educativa con PyScript/Pyodide.
  </footer>
</div>

<script type="py" config='{"packages": ["pandas", "numpy"]}'>
from pyscript import display
import pandas as pd
import numpy as np
import io, js, random

state = {"df": None}

def _write_html(target_id, html):
    js.document.getElementById(target_id).innerHTML = html

def parse_csv(text):
    df = pd.read_csv(io.StringIO(text))
    df.columns = [c.strip().lower() for c in df.columns]
    return df

def compute_metrics(df, threshold=0.5):
    df = df.copy()
    cols = df.columns.tolist()
    if "y_pred" not in cols and "score" in cols:
        df["y_pred"] = (df["score"] >= threshold).astype(int)
    assert {"group","y_true","y_pred"}.issubset(df.columns), "Faltan columnas requeridas"
    groups = list(df["group"].astype(str).unique())
    if len(groups) != 2:
        raise ValueError("Esta demo admite 2 grupos para simplificar (en tus datos hay %d)" % len(groups))
    g0, g1 = sorted(groups)
    def rate_pos(g):
        sub = df[df["group"].astype(str)==g]
        return (sub["y_pred"]==1).mean()
    def tpr(g):
        sub = df[(df["group"].astype(str)==g) & (df["y_true"]==1)]
        return (sub["y_pred"]==1).mean() if len(sub) else float("nan")
    def fpr(g):
        sub = df[(df["group"].astype(str)==g) & (df["y_true"]==0)]
        return (sub["y_pred"]==1).mean() if len(sub) else float("nan")
    spd = rate_pos(g1) - rate_pos(g0)
    eod = tpr(g1) - tpr(g0)
    di  = (rate_pos(g0)+1e-12)/(rate_pos(g1)+1e-12)
    out = {
        "grupos": [g0, g1],
        "paridad_positiva": [rate_pos(g0), rate_pos(g1)],
        "tpr": [tpr(g0), tpr(g1)],
        "fpr": [fpr(g0), fpr(g1)],
        "SPD (g1 - g0)": spd,
        "EOD (g1 - g0)": eod,
        "DI (g0/g1)": di
    }
    return out

def format_pct(x):
    return "—" if pd.isna(x) else f"{x*100:.1f}%"

def render(out, label=""):
    g0, g1 = out["grupos"]
    header = f"<p class='notice'><strong>{label}</strong></p>" if label else ""
    html = f'''
    {header}
    <div class="grid">
      <div>
        <h4>Paridad estadística</h4>
        <p><strong>{g0}</strong>: {format_pct(out["paridad_positiva"][0])}<br>
           <strong>{g1}</strong>: {format_pct(out["paridad_positiva"][1])}</p>
      </div>
      <div>
        <h4>TPR (oportunidad)</h4>
        <p><strong>{g0}</strong>: {format_pct(out["tpr"][0])}<br>
           <strong>{g1}</strong>: {format_pct(out["tpr"][1])}</p>
      </div>
      <div>
        <h4>FPR</h4>
        <p><strong>{g0}</strong>: {format_pct(out["fpr"][0])}<br>
           <strong>{g1}</strong>: {format_pct(out["fpr"][1])}</p>
      </div>
    </div>
    <div class="section">
      <div class="kpis">
        <div class="k"><div class="v">{out["SPD (g1 - g0)"]:+.3f}</div><div class="l">Igualdad ≈ SPD</div></div>
        <div class="k"><div class="v">{out["EOD (g1 - g0)"]:+.3f}</div><div class="l">Equidad ≈ ΔTPR</div></div>
        <div class="k"><div class="v">{out["DI (g0/g1)"]:.3f}</div><div class="l">Disparate Impact</div></div>
      </div>
    </div>
    '''
    _write_html("results", html)

def _gen_example(low_bias=True, n=200):
    random.seed(42); np.random.seed(42)
    group = np.random.choice(["A","B"], size=n, p=[0.5,0.5])
    if low_bias:
        base = 0.5 + 0.02*(group=="B")
        y_true = (np.random.rand(n) < base).astype(int)
        score  = np.clip(0.35 + 0.5*y_true + 0.02*(group=="B") + np.random.randn(n)*0.18, 0, 1)
        label = "Ejemplo 1 · bajo sesgo"
    else:
        base = 0.45 + 0.12*(group=="B")
        y_true = (np.random.rand(n) < base).astype(int)
        score  = np.clip(0.28 + 0.55*y_true + 0.15*(group=="B") + np.random.randn(n)*0.20, 0, 1)
        label = "Ejemplo 2 · sesgo notable"
    df = pd.DataFrame({"group": group, "y_true": y_true, "score": score})
    return df, label

def load_example1():
    df, label = _gen_example(low_bias=True)
    state["df"] = df
    table_html = df.head(10).to_html(index=False, classes="table", border=0)
    _write_html("table-preview", table_html)
    th = float(js.document.getElementById("threshold").value)
    out = compute_metrics(df, threshold=th)
    render(out, label=label)

def load_example2():
    df, label = _gen_example(low_bias=False)
    state["df"] = df
    table_html = df.head(10).to_html(index=False, classes="table", border=0)
    _write_html("table-preview", table_html)
    th = float(js.document.getElementById("threshold").value)
    out = compute_metrics(df, threshold=th)
    render(out, label=label)

def on_file(text):
    df = parse_csv(text)
    state["df"] = df
    table_html = df.head(10).to_html(index=False, classes="table", border=0)
    _write_html("table-preview", table_html)
    th = float(js.document.getElementById("threshold").value)
    out = compute_metrics(df, threshold=th)
    render(out, label="CSV subido")

def on_threshold():
    if state["df"] is None:
        return
    th = float(js.document.getElementById("threshold").value)
    out = compute_metrics(state["df"], threshold=th)
    render(out)

js.window.py_load_example1 = load_example1
js.window.py_load_example2 = load_example2
js.window.py_on_file = on_file
js.window.py_on_threshold = on_threshold
</script>

<script>
  const file = document.getElementById('file');
  const ex1 = document.getElementById('btn-ex1');
  const ex2 = document.getElementById('btn-ex2');
  const th = document.getElementById('threshold');
  const thv = document.getElementById('thv');
  document.getElementById('year').textContent = new Date().getFullYear();

  ex1.addEventListener('click', () => window.py_load_example1());
  ex2.addEventListener('click', () => window.py_load_example2());
  file.addEventListener('change', async (e) => {
    const f = e.target.files[0];
    if(!f) return;
    const text = await f.text();
    window.py_on_file(text);
  });
  th.addEventListener('input', () => {
    thv.textContent = Number(th.value).toFixed(2);
    window.py_on_threshold();
  });

  window.addEventListener('DOMContentLoaded', () => {
    if (window.py_load_example1) window.py_load_example1();
  });
</script>
</body>
</html>
